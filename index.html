<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>2025 Renovations — Project Calendar</title>
<style>
  :root { --brand:#4285f4; --grid:#e5e7eb; --muted:#6b7280; --chip:#e1f5fe; }
  * { box-sizing: border-box; } body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111; }
  header { display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid var(--grid); position:sticky; top:0; background:#fff; z-index:2; }
  .title { font-weight:600; font-size:18px; margin-right:auto; }
  .controls button, .controls select { padding:8px 10px; border:1px solid var(--grid); background:#fff; border-radius:8px; cursor:pointer; font:inherit; }
  .controls button.primary { background:var(--brand); border-color:var(--brand); color:#fff; }
  .calendar { max-width:1200px; margin:12px auto 40px; padding:0 12px; }
  .month-bar { display:flex; align-items:center; gap:10px; margin:14px 0; }
  .month-label { font-size:20px; font-weight:700; }
  .grid { width:100%; border-collapse:collapse; table-layout:fixed; }
  .grid th { text-align:left; padding:8px; color:var(--muted); font-weight:600; border-bottom:1px solid var(--grid); }
  .grid td { vertical-align:top; border:1px solid var(--grid); height:120px; padding:6px; cursor:pointer; background:#fff; }
  .daynum { font-weight:700; font-size:12px; color:#111; }
  .outside { background:#fafafa; color:#9ca3af; }
  .event { background:var(--chip); padding:4px 6px; margin-top:6px; border-radius:6px; font-size:12px; line-height:1.3; cursor:pointer; }
  .filters { display:flex; gap:8px; align-items:center; margin:8px 0 0; }
  .legend { display:flex; gap:8px; align-items:center; margin-left:auto; color:var(--muted); font-size:12px; }
  #eventModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); align-items:center; justify-content:center; z-index:5; }
  .sheet { width:min(520px,92vw); background:#fff; border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,.2); }
  .sheet h3 { margin:0 0 12px; }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  label { display:block; font-size:12px; color:var(--muted); margin:10px 0 4px; }
  input, textarea, select { width:100%; padding:10px; border:1px solid var(--grid); border-radius:8px; font:inherit; }
  textarea { min-height:88px; resize:vertical; }
  .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:14px; }
  .danger { background:#ef4444 !important; border-color:#ef4444 !important; color:#fff !important; }
  .hidden { display:none !important; }
  @media (max-width:700px){ .row { grid-template-columns:1fr; } .grid td { height:100px; } header { flex-wrap:wrap; } }
</style>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Your Supabase values
  const SUPABASE_URL = "https://gvxbqtmbjchvtnrgruft.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2eGJxdG1iamNodH...13F4";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</head>
<body>

<header>
  <div class="title">Project Calendar</div>
  <div class="controls">
    <button id="prevBtn" title="Previous month">‹</button>
    <button id="todayBtn" class="primary" title="Jump to today">Today</button>
    <button id="nextBtn" title="Next month">›</button>
  </div>
  <div class="controls">
    <select id="monthSelect" aria-label="Month"></select>
    <select id="yearSelect" aria-label="Year"></select>
  </div>
</header>

<div class="calendar">
  <div class="month-bar">
    <div class="month-label" id="monthLabel"></div>
    <div class="filters">
      <select id="houseFilter"><option value="">All houses</option></select>
      <input id="contractorFilter" placeholder="Filter by contractor…" />
    </div>
    <div class="legend">Click a day to add; click an event to edit</div>
  </div>
  <table class="grid" id="calendarGrid"></table>
</div>

<!-- Modal -->
<div id="eventModal">
  <div class="sheet">
    <h3 id="modalTitle">Add/Edit Event</h3>
    <input type="hidden" id="eventISODate">
    <input type="hidden" id="editingIndex">
    <div class="row">
      <div><label>Title</label><input id="eventTitle" required placeholder="e.g., Drywall install"/></div>
      <div><label>House</label><select id="eventHouse"></select></div>
    </div>
    <div class="row">
      <div><label>Contractor / Company</label><input id="eventContractor" placeholder="e.g., ABC Reno Co."/></div>
      <div><label>All-day</label>
        <select id="eventAllDay"><option value="1" selected>Yes</option><option value="0">No (set times)</option></select>
      </div>
    </div>
    <div class="row" id="timeRow" class="hidden">
      <div><label>Start (HH:MM)</label><input id="eventStart" placeholder="09:00" /></div>
      <div><label>End (HH:MM)</label><input id="eventEnd" placeholder="12:30" /></div>
    </div>
    <label>Details</label>
    <textarea id="eventDetails" placeholder="Scope, materials arriving, access instructions, parking, etc."></textarea>
    <div class="actions">
      <button id="deleteBtn" class="danger hidden">Delete</button>
      <button id="cancelBtn">Cancel</button>
      <button id="saveBtn" class="primary">Save</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ---- Configurable house list (edit these names anytime) ----
  const HOUSES = ["House 1","House 2"];

  const monthLabel = document.getElementById('monthLabel');
  const grid = document.getElementById('calendarGrid');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const todayBtn = document.getElementById('todayBtn');
  const monthSelect = document.getElementById('monthSelect');
  const yearSelect = document.getElementById('yearSelect');
  const houseFilter = document.getElementById('houseFilter');
  const contractorFilter = document.getElementById('contractorFilter');

  const modal = document.getElementById('eventModal');
  const eventISODate = document.getElementById('eventISODate');
  const editingIndex = document.getElementById('editingIndex');
  const modalTitle = document.getElementById('modalTitle');
  const eventTitle = document.getElementById('eventTitle');
  const eventHouse = document.getElementById('eventHouse');
  const eventContractor = document.getElementById('eventContractor');
  const eventAllDay = document.getElementById('eventAllDay');
  const timeRow = document.getElementById('timeRow');
  const eventStart = document.getElementById('eventStart');
  const eventEnd = document.getElementById('eventEnd');
  const eventDetails = document.getElementById('eventDetails');
  const deleteBtn = document.getElementById('deleteBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const saveBtn = document.getElementById('saveBtn');

  // Calendar state
  let view = new Date(); view.setDate(1);

  // Data cache: { 'YYYY-MM-DD': [rows] }
  let events = {};

  // Build month/year pickers
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  monthNames.forEach((m,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=m; monthSelect.appendChild(opt); });
  const currentYear = new Date().getFullYear();
  for (let y=currentYear-5; y<=currentYear+6; y++){ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; yearSelect.appendChild(opt); }

  // Build house selects from HOUSES
  function buildHouseOptions(){
    houseFilter.innerHTML = `<option value="">All houses</option>` + HOUSES.map(h=>`<option>${h}</option>`).join('');
    eventHouse.innerHTML = HOUSES.map(h=>`<option>${h}</option>`).join('');
  }
  buildHouseOptions();

  // Listeners
  prevBtn.onclick = ()=>{ view.setMonth(view.getMonth()-1); render(); };
  nextBtn.onclick = ()=>{ view.setMonth(view.getMonth()+1); render(); };
  todayBtn.onclick = ()=>{ view = new Date(); view.setDate(1); render(); };
  monthSelect.onchange = ()=>{ view.setMonth(+monthSelect.value); render(); };
  yearSelect.onchange = ()=>{ view.setFullYear(+yearSelect.value); render(); };
  houseFilter.onchange = render;
  contractorFilter.oninput = debounce(render, 200);
  cancelBtn.onclick = closeModal;
  eventAllDay.onchange = ()=> timeRow.classList.toggle('hidden', eventAllDay.value==='1');
  saveBtn.onclick = saveEvent;
  deleteBtn.onclick = deleteEvent;

  // ---- Supabase helpers ----
  function isoDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function startOfWeek(d){ const nd=new Date(d); const diff=(nd.getDay()+7-0)%7; nd.setDate(nd.getDate()-diff); nd.setHours(0,0,0,0); return nd; }

  async function fetchMonth(y,m){
    const start = new Date(y,m,1);
    const end   = new Date(y,m+1,0);
    const s = start.toISOString().slice(0,10);
    const e = end.toISOString().slice(0,10);
    const { data, error } = await sb.from('events').select('*').gte('date',s).lte('date',e).order('date');
    if (error){ console.error(error); return; }
    events = {};
    (data||[]).forEach(row => { (events[row.date] ||= []).push(row); });
  }

  async function render(){
    const y=view.getFullYear(), m=view.getMonth();
    monthLabel.textContent = `${monthNames[m]} ${y}`;
    monthSelect.value = m; yearSelect.value = y;

    await fetchMonth(y,m);

    const weekdays=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    grid.innerHTML=''; const head=document.createElement('tr');
    weekdays.forEach(w=>{ const th=document.createElement('th'); th.textContent=w; head.appendChild(th); }); grid.appendChild(head);

    const first = new Date(y,m,1); const start = startOfWeek(first); let cursor = new Date(start);
    for (let wk=0; wk<6; wk++){
      const tr=document.createElement('tr');
      for (let d=0; d<7; d++){
        const td=document.createElement('td');
        const inMonth = cursor.getMonth()===m;
        if (!inMonth) td.classList.add('outside');
        const dn=document.createElement('div'); dn.className='daynum'; dn.textContent = cursor.getDate(); td.appendChild(dn);

        const key=isoDate(cursor);
        const dayEvents = (events[key]||[])
          .filter(e => !houseFilter.value || e.house===houseFilter.value)
          .filter(e => !contractorFilter.value || (e.contractor||'').toLowerCase().includes(contractorFilter.value.toLowerCase()));

        dayEvents.forEach((e,idx)=>{
          const div=document.createElement('div'); div.className='event';
          const time = e.all_day ? '' : timeSpan(e.start, e.end);
          div.textContent = `${e.title} ${time ? ' • '+time : ''} (${e.house})`;
          div.onclick = (ev)=>{ ev.stopPropagation(); openModal(key, e, idx); };
          td.appendChild(div);
        });

        td.onclick = ()=> openModal(key, null, null);
        tr.appendChild(td); cursor.setDate(cursor.getDate()+1);
      }
      grid.appendChild(tr);
    }
  }

  function timeSpan(s,e){ const fmt = (t)=> (t||'').slice(0,5); return [fmt(s), fmt(e)].filter(Boolean).join('–'); }

  function openModal(key, existing=null, index=null){
    eventISODate.value = key; editingIndex.value = index!=null ? String(index) : '';
    modalTitle.textContent = existing ? 'Edit Event' : 'Add Event';
    eventTitle.value = existing?.title || '';
    eventHouse.value = existing?.house || HOUSES[0];
    eventContractor.value = existing?.contractor || '';
    const isAllDay = existing ? !!existing.all_day : true;
    eventAllDay.value = isAllDay ? '1' : '0';
    timeRow.classList.toggle('hidden', isAllDay);
    eventStart.value = existing?.start || '';
    eventEnd.value = existing?.end || '';
    eventDetails.value = existing?.details || '';
    deleteBtn.classList.toggle('hidden', existing==null);
    modal.style.display='flex';
  }
  function closeModal(){ modal.style.display='none'; }

  async function saveEvent(){
    const key = eventISODate.value;
    const idxStr = editingIndex.value;
    const payload = {
      date: key,
      title: (eventTitle.value||'').trim(),
      house: eventHouse.value,
      contractor: (eventContractor.value||'').trim(),
      all_day: eventAllDay.value==='1',
      start: eventAllDay.value==='1' ? '' : (eventStart.value||'').trim(),
      end:   eventAllDay.value==='1' ? '' : (eventEnd.value||'').trim(),
      details: (eventDetails.value||'').trim()
    };
    if (!payload.title){ alert('Title is required'); return; }
    const existing = (idxStr!=='' && events[key]) ? events[key][+idxStr] : null;
    if (existing?.id) payload.id = existing.id; // upsert -> update
    const { error } = await sb.from('events').upsert(payload).select().single();
    if (error){ alert('Save failed'); console.error(error); return; }
    closeModal(); await render();
  }

  async function deleteEvent(){
    const key = eventISODate.value; const idxStr = editingIndex.value;
    if (idxStr===''){ closeModal(); return; }
    if (!confirm('Delete this event?')) return;
    const row = events[key][+idxStr];
    if (!row?.id){ closeModal(); return; }
    const { error } = await sb.from('events').delete().eq('id', row.id);
    if (error){ alert('Delete failed'); console.error(error); return; }
    closeModal(); await render();
  }

  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms); }; }
  modal.addEventListener('click', (e)=>{ if (e.target===modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeModal(); });

  render();
})();
</script>
</body>
</html>
